var electron=null;"undefined"!=typeof _Electron&&(electron=require("electron"));var ProxyRequest=function(e={},t){var r=this,n=function(e,t,r){var n=new AbortController,s=3e4;return(window.cordova||isInStandaloneMode())&&(s=55e3),function(e,t,r){return new Promise(((n,o)=>{const s=setTimeout((()=>{r.signal.dontabortable||r&&r.abort()}),e);t.then((e=>{clearTimeout(s),n(e)})).catch((e=>{clearTimeout(s),o(e)}))}))}(s,o(e,t,n.signal,r),n)},o=function(r,n,o,s){s||(s={}),n||(n={});var i=_.extend({Accept:"application/json","Content-Type":"application/json;charset=utf-8"},s.headers||{}),c=!1;return s.auth?n=function(r){var n=null,o="";if(t&&t.session&&(o=t.session),e.user&&e.user.getstate&&1==e.user.getstate())try{n=e.user.signature(o)}catch(e){}return n&&(r.signature=n),r}(n):e.user&&e.user.getstate&&1==e.user.getstate()&&(n.state=1),fetch(r,{method:s.method||"POST",mode:"cors",headers:i,signal:o,body:JSON.stringify(n)}).then((e=>(o.dontabortable=!0,e.ok||(c=!0),e.json()))).then((e=>c?Promise.reject(e.error):Promise.resolve(e.data||{}))).catch((e=>20==e.code?Promise.reject({code:408}):Promise.reject(e)))};return r.rpc=function(e,t,r,o){if(!t)return Promise.reject("method");var s={};s.parameters=r||[],s.method=t,o&&(s.options=o);var i="rpc";return o.ex&&(i="rpc-ex"),n(e+"/"+i+"/"+t,s)},r.fetch=function(e,t,r,o){return n(e+"/"+t,r,o)},r},Node=function(e,t){var r=this;return r.host=e.host||"",r.port=e.port||0,r.wss=e.wss||0,r.id=r.host+":"+r.port+":"+r.wss,r},Proxy16=function(e,t,r){var n=this,o=new ProxyRequest(t,n);n.system=new System16(t,n,e.direct),n.host=e.host||"",n.port=e.port||0,n.wss=e.wss||0,n.direct=e.direct,n.user=e.user||!1,n.current=null,n.id=n.host+":"+n.port+":"+n.wss,n.enabled=!0,nodes=[];var s={hash:[],tick:{}},i={node:{manage:{addlist:function(e){_.each(e,(e=>{this.add(e)}))},add:function(e){var r=new Node(e,t);nodes.push(r)}}}};return n.changeNode=function(e){if(e&&n.current.key!=e.key)return n.current=e,t.platform.ws.reconnect(),_.each(n.clbks.changednode,(function(e){e()})),!0},n.export=function(){return{host:n.host,port:n.port,wss:n.wss,user:n.user}},n.changed=function(e){var r=!1;if(e.ports||e.host){(e.ports||{}).https&&(n.port=e.ports.https),(e.ports||{}).wss&&(n.wss=e.ports.wss,r=!0),e.host&&(n.host=e.host,r=!0);var o=n.id;n.id=n.host+":"+n.port+":"+n.wss;var s=t.api.get.currentstring();t.api.editinsaved(o,n),s==o&&t.api.set.current(n.id,r)}return void 0!==e.enabled&&(n.enabled=e.enabled),e.ssl&&(r=!0),e.firebase,_.each(n.clbks.changed,(function(t){t(e)})),r},n.api={ping:()=>n.fetch("ping").then((e=>(n.ping=new Date,n.session=e.session,Promise.resolve(e)))).catch((e=>Promise.reject(e))),actualping:function(){return(!n.ping||n.ping.addSeconds(50)<new Date?n.api.ping():Promise.resolve(!0)).catch((e=>Promise.resolve(!1)))},nodes:{canchange:function(e){return n.fetch("nodes/canchange",{node:e},"wait").then((e=>Promise.resolve(n.changeNode(e.node)))).catch((e=>Promise.resolve(!1)))},select:function(){var e="";return r&&r.get.fixednode()&&(e=r.get.fixednode()),n.fetch("nodes/select",{fixed:e}).then((e=>(n.current=e.node,Promise.resolve(e))))},get:()=>n.fetch("nodes/get").then((e=>(i.node.manage.addlist(e.nodes),Promise.resolve(e)))),addlist:function(e){_.each(e,(e=>{this.add(e)}))},add:function(e){var r=new Node(e,t);this.find(r.id)||nodes.push(r)},find:function(e){return _.find(nodes,(t=>t.id==e))}}},n.url={https:()=>"https://"+n.host+":"+n.port,wss:()=>"wss://"+n.host+":"+n.wss},n.rpc=function(e,t,r,s){s||(s=0),r||(r={}),n.current&&(r.node=n.current.key);return(n.direct?n.system.rpc(e,t,r):o.rpc(n.url.https(),e,t,r)).then((e=>Promise.resolve(e))).catch((o=>408==o.code&&r.node&&s<3?n.api.nodes.canchange(r.node).then((i=>i?n.rpc(e,t,r,s+1):Promise.reject(o))):Promise.reject(o)))},n.fetch=function(e,t,r){return(n.direct?n.system.fetch(e,t,r):o.fetch(n.url.https(),e,t,r)).then((e=>Promise.resolve(e)))},n.fetchauth=function(e,t,r){return r||(r={}),r.auth=!0,n.fetch(e,t,r)},n.get={nodes:()=>nodes,name:function(){return n.direct?"Electron Proxy":n.url.https()},info:function(){return n.fetchauth("info")},stats:function(){return n.fetchauth("stats")}},n.valid=function(){return n.host&&n.port&&n.wss},n.init=function(){return n.direct&&n.system.listen(),n.system.clbks.tick.proxy=function(e,t){if(t){var r=bitcoin.crypto.hash256(JSON.stringify(t)),o=r.join("")!==s.hash.join("");s.hash=r,s.tick=t,_.each(n.clbks.tick,(e=>{e(s.tick,o)}))}},n.refreshNodes()},n.refreshNodes=function(){return n.api.nodes.select().catch((e=>Promise.resolve()))},n.destroy=function(){n.direct&&n.system.stop(),nodes=[]},n.clbks={tick:{},changed:{},changednode:{}},n},Api=function(e){var t=this,r=[],n=null,o=!1,s=null,i=function(e){return e||(e=n),_.isObject(e)?e:_.find(r,(function(t){return t.id==e}))},c=function(e){var t=i(e);return t?Promise.resolve(t):Promise.reject("proxy")};t.addproxy=function(e){var t=JSON.parse(localStorage.listofproxies||"[]"),r=a.proxy.manage.add(e);if(r)return t.push(e),a.proxy.manage.savelist(t),r},t.removeproxy=function(t){var o=JSON.parse(localStorage.listofproxies||"[]");o=_.filter(o,(function(r){return new Proxy16(r,e).id!=t})),r=_.filter(r,(function(e){if(e.id!=t||e.direct)return!0;e.destroy()})),n==t&&r.length&&(n=r[0].id),a.proxy.manage.savelist(o)},t.editinsaved=function(e,t){var r=JSON.parse(localStorage.listofproxies||"[]"),n=_.find(r,(function(t){return t.host+":"+t.port+":"+t.wss==e}));n&&(n.host=t.host,n.port=t.port,n.wss=t.wss,a.proxy.manage.savelist(r))},t.editproxy=function(e,r){var n=t.get.byid(e);return n.changed({host:r.host,ports:{https:r.port,wss:r.wss}}),n};var a={api:{manage:{}},proxy:{manage:{savelist:function(e){localStorage.listofproxies=JSON.stringify(e||[])},init:function(){return this.addlocalelectronproxy().then((t=>{this.addlist(deep(e,"options.listofproxies")||[]);try{this.addlist(JSON.parse(localStorage.listofproxies||"[]"))}catch(e){}return Promise.resolve()})).then((e=>{var r=localStorage.currentproxy;return r?t.set.current(r):Promise.resolve()})).catch((e=>Promise.resolve())).then((()=>(!n&&r.length&&(n=r[0].id),o=!0,Promise.resolve())))},addlocalelectronproxy:function(){if(electron){var t=new System16(e,null,!0);return t.listen(),t.request("get.settings").then((e=>(t.stop(),this.add({direct:!0,host:"localhost",port:deep(e,"server.ports.https")||0,wss:deep(e,"server.ports.wss")||0}),Promise.resolve())))}return Promise.resolve()},addlist:function(e){_.each(e,(e=>{this.add(e)}))},add:function(n){var o=new Proxy16(n,e,t);if(!this.find(o.id)&&(o.valid()||o.direct))return r.push(o),o.init(),o},find:function(e){return _.find(r,(t=>t.id==e))}},api:{ping:function(e){var t=_.map(e,(e=>e.api.ping()));return Promise.all(t)}}}};return t.rpc=function(t,r,n){return t?(n||(n={}),c(n.proxy).then((e=>e.rpc(t,r,n.rpc))).then((t=>(e.apiHandlers.success({rpc:!0}),Promise.resolve(t)))).catch((t=>(console.log("ER",t),"TypeError: Failed to fetch"!=t&&"proxy"!=t&&408!=t.code&&-28!=t.code||e.apiHandlers.error({rpc:!0}),Promise.reject(t))))):Promise.reject("method")},t.fetchauth=function(e,r,n){return n||(n={}),n.auth=!0,t.fetch(e,r,n)},t.fetch=function(t,r,n){n||(n={});var o="fetch";return n.auth&&(o="fetchauth"),c(n.proxy).then((e=>e[o](t,r))).then((t=>(e.apiHandlers.success({api:!0}),Promise.resolve(t)))).catch((t=>("TypeError: Failed to fetch"==t&&e.apiHandlers.error({api:!0}),Promise.reject(t))))},t.ready={proxies:()=>_.filter(r,(e=>e.ping)),use:()=>_.filter(r,(e=>e.ping)).length||!r.length,useexternal:()=>_.filter(r,(e=>e.ping&&!e.direct)).length||!r.length},t.wait={ready:function(e,r){return e||(e="use"),pretry(t.ready[e],20,r)}},t.set={current:function(r,o){var s=t.get.byid(r);return s?(n=r,localStorage.currentproxy=n,o&&e.platform.ws.reconnect(),Promise.resolve()):Promise.reject("hasnt")},fixednode:function(e){s=e,localStorage.fixednode=s}},t.get={fixednode:function(){return s},currentwss:function(){return c().then((e=>e.direct?{dummy:e.system.wssdummy,proxy:e}:{url:e.url.wss(),proxy:e}))},proxies:function(){return r},current:function(){return i()},currentstring:function(){return n},byid:function(e){return _.find(r,(function(t){return t.id==e}))},working:function(){var e=_.filter(r,(function(e){return!e.direct})),t=_.map(e,(function(e){return e.api.actualping()}));return Promise.all(t).then((e=>_.filter(r,(function(t,r){if(e[r])return!0}))))},direct:function(){var e=_.filter(r,(function(e){return e.direct}));if(e.length)return e[0]}},t.changeProxyIfNeed=function(){var e=i();return(e?e.api.actualping():Promise.resolve(!1)).then((e=>e?Promise.resolve(1):t.get.working().then((e=>(e.length&&t.set.current(e[0].id),Promise.resolve(e.length))))))},t.init=function(){var e=localStorage.fixednode;return e&&(s=e),a.proxy.manage.init().then((e=>(a.proxy.api.ping(r).catch((e=>{console.log("ERROR",e)})),Promise.resolve())))},t.initIf=function(){return o?Promise.resolve():t.init()},t.destroy=function(){r=[],o=!1},t};"undefined"!=typeof module?module.exports={Api:Api,ProxyRequest:ProxyRequest,Proxy16:Proxy16,Node:Node}:(window.Api=Api,window.ProxyRequest=ProxyRequest,window.Proxy16=Proxy16);