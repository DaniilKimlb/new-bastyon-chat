var pSDK=function({actions:e,api:t,app:r}){var s=this,n={},a={},o={},i={},c={},u={accSet:{time:6e3},blocking:{time:600},comment:{authorized:!0,time:120},commentRequest:{authorized:!0,time:60},myScore:{authorized:!0,time:6e3},myScoreFB:{authorized:!0,time:6e3},nameAddress:{time:6e3},postScores:{time:240},searchRequest:{time:240},searchUsersRequest:{time:120},share:{time:240},shareRequest:{time:60},subscribers:{time:600},subscribes:{time:600},tagRequest:{time:6e3},userInfoFull:{time:600},userInfoFullFB:{time:0},userInfoLight:{time:3e4},userState:{time:600},userStateFB:{time:0}},d=_.map(u,((e,t)=>t)),l=2+d.length;s.db=new ResoursesDB("psdk_"+(window.testpocketnet?"test":"production"),l,d);performance.now();s.db.getdb().then((()=>{})).catch((e=>{console.error(e)})),s.actions=e;var m=function(t){var r=e.getCurrentAccount();if(r){var s=_.filter(_.map(t,(e=>e.txid||e)),(e=>e&&!_.isObject(e)));r.checkTransactionById(s)}},p=function(e){n[e]||(n[e]={}),i[e]||(i[e]={}),a[e]||(a[e]={}),c[e]||(c[e]={a:[],d:0,mc:0}),o[e]||(o[e]={})},f=function(e,t){return e&&u[e]?Promise.all(_.map(t,(({data:t,key:n})=>t?t.___temp?Promise.resolve():(u[e].authorized&&(n=n+"_"+r.user.address.value),s.db.set(e,u[e].time,n,t).catch((e=>(console.error(e),Promise.resolve())))):Promise.resolve()))):Promise.resolve()},h=function(e,t){return e&&u[e]?(u[e].authorized&&(t=_.map(t,(e=>e+"_"+r.user.address.value))),s.db.clearMany(e,t).catch((e=>(console.error(e),Promise.resolve())))):Promise.resolve()},y=function(e){return e&&u[e]?s.db.clearAll(e):Promise.resolve()},g=function(e,t,r){return v(e,t,r).then((e=>e.length?Promise.resolve(e[0].data):Promise.resolve(null)))},v=function(e,t,n){if(!t)return Promise.resolve([]);if(_.isArray(t)||(t=[t]),!e)return Promise.resolve([]);u[e].authorized&&(t=_.map(t,(e=>e+"_"+r.user.address.value)));var a=[];return Promise.all(_.map(t,(t=>s.db.get(e,t,n).then((({data:s,date:n})=>{u[e].authorized&&(t=t.replace("_"+r.user.address.value,"")),a.push({data:s,date:n,key:t})})).catch((e=>{}))))).then((()=>a))},b=function(e,t,r,s){return S(e,[t],r,s)},k=function(){_.each(c,((e,t)=>{e.d&&e.d>0?e.d=e.d-300:(!function(e){if(e.a.length){var t=_.toArray(group(e.a,(e=>e.executor)));_.each(t,(t=>{var r=t[0].executor,s=_.reduce(t,((e,t)=>e.concat(t.load)),[]);s=_.uniq(s);var n=[];if(e.mc)for(let t=0;t<s.length;t+=e.mc){var a=s.slice(t,t+e.mc);n.push(a)}else n.push(s);Promise.all(_.map(n,(e=>r(e)))).then((e=>Promise.resolve(_.flatten(e,!0)))).then((e=>{_.each(t,(t=>{var r=_.filter(e,(e=>{if(e&&e.key)return _.indexOf(t.load,e.key)>-1}));t.resolve(r)}))})).catch((e=>{_.each(t,(t=>{t.reject(e)}))}))}))}}(e),c[t]={a:[],d:0,mc:0})}))},S=function(e,t,r,s={alternativeGetStorage:null,fallbackIndexedDB:null,ignoreBadData:!1,indexedDb:null,maxcount:0,transform:null,update:!1}){if(!e)return Promise.reject("missing:key");if(!t)return Promise.reject("missing:keys");_.isArray(t)||(t=[t]),t=_.filter(_.uniq(t),(e=>e)),s.ignoreBadData&&(t=_.filter(t,(t=>(s.update&&o[e][t]&&delete o[e][t],!o[e][t]))));var u={},d={},l=[];_.each(t,(t=>{if(s.alternativeGetStorage){if(i[s.alternativeGetStorage][t])return void(u[t]=i[s.alternativeGetStorage][t]);if(!s.update&&n[s.alternativeGetStorage][t]&&!n[s.alternativeGetStorage][t].___temp)return void(d[t]=n[s.alternativeGetStorage][t])}i[e][t]?u[t]=i[e][t]:(n[e][t]&&n[e][t].___temp&&R(e,t),s.update||!n[e][t]||n[e][t].___temp?l.push(t):d[t]=n[e][t])}));var m=_.clone(l),p=l.length?new Promise(((t,n)=>{(s.update?Promise.resolve([]):v(s.indexedDb,l)).then((a=>{if(l=_.filter(l,(e=>!_.find(a,(({key:t})=>t==e)))),l.length){var o=function(e){v(s.indexedDb,l,!0).then((r=>{r&&r.length==l.length?t(r):n(e)})).catch((e=>{console.error(e),n(e)}))},i=e=>{s.transformResult&&(e=s.transformResult(e)),f(s.indexedDb,e).then((()=>{f(s.fallbackIndexedDB,e)})),t(e.concat(a))};if(s.queue)c[e].a.length||(s.queueDelay&&(c[e].d=s.queueDelay),s.maxcount&&(c[e].mc=s.maxcount)),c[e].a.push({executor:r,load:l,reject:o,resolve:i});else{var u=[];if(s.maxcount)for(let e=0;e<l.length;e+=s.maxcount)u.push(l.slice(e,e+s.maxcount));else u.push(l);Promise.all(_.map(u,(e=>r(e)))).then((e=>{i(_.flatten(e,!0))})).catch(o)}}else t(a)}))})).catch((e=>(console.error(e),s.fallbackIndexedDB?v(s.fallbackIndexedDB,l):Promise.reject(e)))).then((t=>{var r=[];try{_.each(t,(t=>{if(t&&t.key&&t.data?(n[e][t.key]=t.data,r.push(t)):t&&t.key&&(o[e][t.key]=!0),s.transform){var i=s.transform(t);i&&(a[e][t.key]=i)}}))}catch(e){console.error(e)}return r})).finally((()=>{_.each(m,(t=>{delete i[e][t]}))})):Promise.resolve([]);return _.each(m,(t=>{i[e][t]=p})),Promise.all([p]).catch((e=>null)).then((e=>{_.each(e,(e=>{e&&_.each(e,(e=>{d[e.key]=e.data}))}))})).then((()=>d))},I=function(e,t,r,s={insertFromResponse:null,requestIndexedDb:null}){if(_.isObject(t))try{t=$.md5(JSON.stringify(t))}catch(e){t=null}return i[e][t]||(i[e][t]=g(s.requestIndexedDb,t).then((e=>e?Promise.resolve(e):r().then((e=>(s.transformResult&&(e=s.transformResult(e)),function(e,t,r){t&&r?f(e,[{data:r,key:t}]):Promise.resolve()}(s.requestIndexedDb,t,e),Promise.resolve(e)))).catch((e=>g(s.requestIndexedDb,t,!0).then((t=>t?Promise.resolve(t):Promise.reject(e))))))).then((e=>s.insertFromResponse?s.insertFromResponse(e).then((()=>e)):e)).finally((()=>{delete i[e][t]}))),i[e][t]},x={};s.extendCache=x;var R=function(e,t){_.each(x,((r,s)=>{0==s.indexOf(e+":"+(t||""))&&delete x[s]}))};s.clearIdCacheAll=function(){x={},s.extendCache=x};var A=function(t,r,n,a){var o=t+":"+(a||"")+":"+_.reduce(r,((e,t)=>{}),"")+(a||"");if(x[o])return x[o];var i=null;return _.each(e.getAccounts(),(e=>{_.each(r,(r=>{_.each(e.getTempActions(r),(e=>{if(r==t&&a){if(!n&&(e.id==a||e.actionId==a||"userInfo"==r&&e.actor==a))return void(i=e);if(!n)return}if((i||n)&&s[r]&&s[r].applyAction){var o=s[r].applyAction(i||n.clone(),e);o&&(i=o)}}))}))})),x[o]=i||n,i||n};s.userInfo={applyAction:function(e,t){return e||t.actor!=r.user.address.value?(e.address==t.actor&&(e.name=t.name,e.image=t.image,e.language=t.language,e.about=t.about,e.site=t.site,e.txid=t.txid,e.temp=t.temp,e.relay=t.relay,e.extended=!0),e):t},cleanData:function(e){return _.filter(_.map(e,(e=>{try{e.name=clearStringXss(decodeURIComponent(e.name||"")),e.i=checkIfAllowedImageApply(clearStringXss(trydecode(e.i||""))),e.s=clearStringXss(trydecode(e.s||"")),e.l=clearStringXss(trydecode(e.l||"")),e.a=clearStringXss(trydecode(e.a||"")),e.address=clearStringXss(e.address)}catch(e){return console.error(e),null}return e})),(e=>e))},clearAll:function(e){this.clearStorage(e),this.cleardb(e)},cleardb:function(e){h("userInfoFullFB",[e]),h("userInfoFull",[e]),h("userInfoLight",[e])},clearStorage:function(e){delete n.userInfoFull[e],delete n.userInfoLight[e],delete a.userInfoFull[e],delete a.userInfoLight[e]},findlocal:function(e){return _.find(_.toArray(a.userInfoFull).concat(a.userInfoLight),e)},get:function(e){return this.tempExtend(a.userInfoFull[e]||a.userInfoLight[e],e)},getclear:function(e){return n.userInfoFull[e]||n.userInfoLight[e]},getmy:function(){return r.user.address.value?this.get(r.user.address.value):null},getmyoriginal:function(){return r.user.address.value?a.userInfoFull[r.user.address.value]||a.userInfoLight[r.user.address.value]:null},gets:function(e){return _.map(e,(e=>this.get(e)))},getShortForm:function(e){e||(e=r.user.address.value);var t=this.get(e)||{},s=r.platform.api.clearname(t.name||e)||e;return{about:t.about,address:e,addresses:t.addresses||[],clname:r.platform.api.clearname(t.name),deleted:t.deleted,dev:t.dev||!1,image:t.image,itisme:e==r.user.address.value,letter:(s?s[0]:"").toUpperCase(),name:s,real:r.platform.real[e],regdate:t.regdate,reputation:t.reputation||0}},insertFromResponse:function(e,t){var r=_.map(e,(e=>({data:e,key:e.address}))),s=t?null:"userInfoFullFB",o=t?"userInfoLight":"userInfoFull";return f(t?"userInfoLight":"userInfoFull",r).then((()=>f(s,r))).then((()=>{var e=[];return _.each(r,(t=>{if(t&&t.key&&t.data&&(n[o][t.key]=t.data,e.push(t)),!a[o][t.key]){var r=this.transform(t);r&&!a[o][t.key]&&(a[o][t.key]=r)}})),e}))},insertFromResponseSmall:function(e,t){var r=_.map(e,(e=>({data:e,key:e.address||e.adr}))),s=t?"userInfoLight":"userInfoFull";_.each(r,(e=>{n[s][e.key]||(n[s][e.key]=e.data);var t=this.transform(e);t&&!a[s][e.key]&&(a[s][e.key]=t)}))},keys:["userInfoFull","userInfoLight"],listener:function(e,t,r){"completed"==r&&(a.userInfoFull[t]=this.applyAction(a.userInfoFull[t],e),this.cleardb(t))},load:function(e,r,s){return S(r?"userInfoLight":"userInfoFull",e,(e=>{var s=[e];return r&&s.push("1"),t.rpc("getuserprofile",s).then((t=>(t=this.cleanData(t),_.map(e,(e=>({data:_.find(t,(t=>t.address==e)),key:e}))))))}),{alternativeGetStorage:r?"userInfoFull":null,fallbackIndexedDB:r?null:"userInfoFullFB",ignoreBadData:!0,indexedDb:r?"userInfoLight":"userInfoFull",maxcount:r?70:10,queue:!!r,transform:e=>this.transform(e),update:s})},tempExtend:function(e,t){return A("userInfo",["userInfo","blocking","unblocking","subscribe","subscribePrivate","unsubscribe","accDel"],e,t)},transform:function({data:e,key:t}){var r=null;return e&&((r=new pUserInfo)._import(e),e.subscribers&&(r.subscribers_loaded=!0),e.subscribes&&(r.subscribes_loaded=!0),e.blocking&&(r.blocking_loaded=!0),R("userInfo",r.address)),r}},s.userState={change:function(e,t){this.clear.all("userState",e),n.userState[e]=t},changeLimits:function(e,t,r){var s=this.get(e);s&&(s[t+"_spent"]=(s[t+"_spent"]||0)+r,s[t+"_unspent"]=(s[t+"_unspent"]||1)-r)},get:function(e){return n.userState[e]},getmy:function(){return r.user.address.value?this.get(r.user.address.value):null},keys:["userState"],load:function(e,r){return S("userState",e,(e=>t.rpc("getuserstate",[e.join(",")]).then((e=>(e&&!_.isArray(e)&&(e=[e]),_.filter(_.map(e||[],(e=>({data:_.isEmpty(e)?null:e,key:e.address}))),(e=>e.data))))).catch((t=>t&&-5==t.code?Promise.resolve(_.map(e,(e=>({data:null,key:e})))):Promise.reject(t)))),{fallbackIndexedDB:"userStateFB",indexedDb:"userState",update:r})}},s.accSet={applyAction:function(e,t){return e||t.actor!=r.user.address.value?(e.address==t.actor&&(e.pin=t.pin,e.temp=t.temp,e.relay=t.relay,e.extended=!0),e):t},cleardb:function(e){h("accSet",[e])},get:function(e){return this.tempExtend(a.accSet[e]||null,e)},keys:["accSet"],listener:function(e,t,r){"completed"==r&&this.cleardb(t)},load:function(e,r){return b("accSet",e,(e=>t.rpc("getaccountsetting",[e[0]]).then((t=>{var r={};try{r=JSON.parse(t||"{}")}catch(e){}return[{data:{d:r},key:e[0]}]}))),{indexedDb:"accSet",transform:e=>this.transform(e),update:r})},tempExtend:function(e,t){return A("accSet",["accSet"],e,t)},transform:function({data:e,key:t}){var r=new pSettings;return r._import(e),r.address=t,r}},s.comment={applyAction:function(e,t){if(e){if("share"==e.type&&e.txid==t.postid){if("comment"==t.optype){e.comments++;var r=e.lastComment?s.comment.get(e.lastComment):null;t.parentid?r&&(t.parentid,r.id):(!r||Number(r.timeUpd)<Number(t.timeUpd))&&(e.lastComment=t.id)}if(t.optype,"commentDelete"==t.optype)if(e.comments>0&&e.comments--,t.parentid)(r=e.lastComment?s.comment.get(e.lastComment):null)&&(t.parentid,r.id)}if("comment"==e.type){if("comment"==t.optype){if(e.id==t.id)return t;e.id==t.parentid&&e.children++}"commentEdit"==t.optype&&e.id==t.id&&(e.message=t.message,e.timeUpd=t.timeUpd),"commentDelete"==t.optype&&(e.id==t.id&&(e.deleted=!0),e.id==t.parentid&&e.children--)}}return e},cleanData:function(e){return _.filter(_.map(e,(e=>{if(!e.msgparsed&&!e.msg)return null;try{if(e.msgparsed=e.msgparsed||JSON.parse(e.msg),!_.isObject(e.msgparsed))return null;e.msgparsed.url=clearStringXss(trydecode(e.msgparsed.url||"")),e.msgparsed.message=clearStringXss(trydecode(e.msgparsed.message||"")).replace(/\n{2,}/g,"\n\n"),e.msgparsed.images=_.filter(_.map(e.msgparsed.images||[],(function(e){return checkIfAllowedImageApply(clearStringXss(trydecode(e)))})),(function(e){return e}))}catch(t){return console.error(t),console.log(e),null}return e})),(e=>e))},get:function(e){return this.tempExtend(e&&a.comment[e]||null,e)},getclear:function(e){return a.comment[e]||null},gets:function(e){return _.isArray(e)||(e=[e]),_.filter(_.map(e,(e=>this.get(e))),(e=>e))},insertFromResponse:function(e){var t=_.map(e,(e=>e?{data:e,key:e.id}:null)),r="comment",s=[];return _.each(t,(e=>{e&&e.key&&e.data&&(n[r][e.key]=e.data,s.push(e));var t=this.transform(e);t&&(a[r][e.key]=t,m([{txid:t.id}]))})),s},insertFromResponseEx:function(e){return Promise.resolve(this.insertFromResponse(e))},insertFromResponseSmall:function(e){var t=_.map(e,(e=>e?{data:e,key:e.id}:null)),r="comment";_.each(t,(e=>{n[r][e.key]||(n[r][e.key]=e.data);var t=this.transform(e);t&&!a[r][e.key]&&(a[r][e.key]=t)}))},keys:["comment"],listener:function(e,t,r){"completed"==r&&("comment"==e.optype?a.comment[e.id]=this.applyAction(a.comment[e.id]||e,e):this.applyAction(a.comment[e.id],e),this.applyAction(a.share[e.postid],e),y("commentRequest"),h("share",[e.postid]))},load:function(e,s){return S("comment",e,(e=>t.rpc("getcomments",["","",r.user.address.value||"",e]).then((e=>(e=this.cleanData(e),m(_.map(e,(e=>({txid:e.id})))),_.map(e||[],(e=>({data:e,key:e.id}))))))),{indexedDb:"comment",transform:e=>this.transform(e),update:s})},request:function(e,t){return I("comment",t,(t=>e(t).then((e=>this.cleanData(e)))),{insertFromResponse:e=>this.insertFromResponseEx(e),requestIndexedDb:"commentRequest"})},tempAdd:function(t=[],r){return _.each(e.getAccounts(),(e=>{var s=_.filter(e.getTempActions("comment"),r);_.each(s,(e=>{"comment"==e.optype&&t.unshift(e)}))})),t},tempExtend:function(e,t){return A("comment",["comment","cScore"],e,t)},transform:function({data:e,key:t}){var r=new pComment;return r.import(e),r}},s.cScore={applyAction:function(e,t){if(e&&e.id==t.comment.v){var s=Number(t.value.v);t.actor==r.user.address.value&&(e.myScore=s),s>0?e.scoreUp=(e.scoreUp||0)+1:e.scoreDown=(e.scoreDown||0)+1}return e},listener:function(e,t,s){if("completed"==s){a.comment[e.comment.v]=this.applyAction(a.comment[e.comment.v],e);var n={data:{cmntid:e.comment.v,myScore:Number(e.value.v)},key:e.comment.v};e.actor==r.user.address.value&&f("myScore",[n]).then((()=>{})).catch((e=>{console.error(e)}))}}},s.share={applyAction:function(e,t){if(t.editing){if(!e)return;t.txid==e.txid&&(e.message=t.message,e.caption=t.caption,e.tags=t.tags,e.url=t.url,e.language=t.language,e.repost=t.repost,e.settings=_.clone(t.settings),e.edit=!0,e.temp=t.temp,e.relay=t.relay,e.rejected=t.rejected)}return e},cleanData:function(e){return _.filter(_.map(e,(e=>{if(!e)return!1;try{if(e.u=clearStringXss(trydecode(e.u||"")),e.c=clearStringXss(trydecode(e.c||"")).replace(/&nbsp;/g," "),e.s&&"a"==e.s.v)if(e.s.version>=2)_.isObject(e.m)||(e.m=JSON.parse(e.m));else{var t={"js-player":!0,"medium-insert-embeds":!0,"medium-insert-images":!0,"medium-insert-images-grid":!0,plyr:!0};e.m=superXSS(trydecode(e.m||""),{onIgnoreTagAttr:function(e,r,s,n){if("class"===r){var a=s.split(" ");return r+'="'+(a=_.filter(a,(function(e){return t[e]}))).join(" ")+'"'}},stripIgnoreTag:!0,whiteList:{a:["href","title","target","cordovalink"],b:["style"],blockquote:[],br:["style"],div:["data-plyr-provider","data-plyr-embed-id"],em:[],figcaption:["style"],figure:["style"],h1:[],h2:[],h3:[],h4:[],h5:[],i:["style"],img:["src"],li:[],ol:[],p:[],picture:["img-type"],source:["srcset","type"],span:["style"],strike:[],strong:[],u:[],ul:[]}}).replace(/http:\/\//g,"https://").replace(/\n{2,}/g,"\n\n")}else e.m=trimrn(superXSS(trydecode(e.m||""),{stripIgnoreTag:!0,whiteList:[]})).replace(/\n{2,}/g,"\n\n");e.t=_.map(e.t||[],(function(e){return clearStringXss(clearTagString(trydecode(e)))})),e.i=_.filter(_.map(e.i||[],(function(e){return checkIfAllowedImageApply(clearStringXss(e))})),(function(e){return e}))}catch(e){return console.error(e),null}return e})),(e=>e))},get:function(e){return this.tempExtend(e&&a.share[e]||null,e)},gets:function(e){return _.isArray(e)||(e=[e]),_.filter(_.map(e,(e=>this.get(e))),(e=>e))},insertFromResponse:function(e){var t=_.map(e,(e=>e?{data:e,key:e.txid}:null)),r="share";return f("share",t).then((()=>{var e=[];return _.each(t,(t=>{t&&t.key&&t.data&&(n[r][t.key]=t.data,e.push(t));var s=this.transform(t);s&&(a[r][t.key]=s,m([s]))})),e}))},insertFromResponseEx:function(e){return s.userInfo.insertFromResponse(s.userInfo.cleanData(e.users),!0),r.platform.sdk.videos.getVideoResponse(e.videos),this.insertFromResponse(e.contents)},insertFromResponseSmall:function(e,t){t||(e=this.cleanData(e));var r=_.map(e,(e=>e?{data:e,key:e.txid}:null)),s="share";return _.each(r,(e=>{(!n[s][e.key]||n[s][e.key]&&n[s][e.key].___temp)&&(n[s][e.key]=e.data);var t=this.transform(e,!0);!t||a[s][e.key]&&a[s][e.key].___temp||(a[s][e.key]=t)})),e},keys:["share"],listener:function(e,t,r){if("completed"==r){y("shareRequest"),h("share",_.filter([e.txid],(e=>e)));var s=this.applyAction(a.share[e.txid],e);s?a.share[s.txid]=s:a.share[e.txid]=e}},load:function(e,r){return S("share",e,(e=>t.rpc("getrawtransactionwithmessagebyid",[e]).then((t=>(t&&!_.isArray(t)&&(t=[t]),t=this.cleanData(t),t=_.sortBy(t,(t=>_.indexOf(e,t.txid))),t=_.filter(t||[],(e=>e.address)),m(t),_.map(t||[],(e=>({data:e,key:e.txid}))))))),{indexedDb:"share",queue:!0,transform:e=>this.transform(e),update:r})},request:function(e,t){return I("share",t,(t=>e(t).then((e=>(e.boosts||(_.isArray(e)&&(e={contents:e}),e.contents?e.contents=this.cleanData(e.contents):e=this.cleanData(e)),e)))),{insertFromResponse:e=>this.insertFromResponseEx(e),requestIndexedDb:"shareRequest"})},tempAdd:function(t=[],r){return _.each(e.getAccounts(),(e=>{var s=_.filter(e.getTempActions("share"),r);_.each(s,(e=>{t.unshift(e)}))})),t},tempExtend:function(e,t){return A("share",["share","upvoteShare","comment","contentDelete"],e,t)},transform:function({data:e,key:t},r){(e.userprofile||e.user)&&s.userInfo[r?"insertFromResponseSmall":"insertFromResponse"](s.userInfo.cleanData([e.userprofile||e.user]),!0),e.lastComment&&s.comment[r?"insertFromResponseSmall":"insertFromResponse"](s.comment.cleanData([e.lastComment]));var n=new pShare;return n._import(e),e.ranks?n.info=e.ranks:(e.BOOST||e.DPOST||e.DREP||e.LAST5||e.LAST5||e.LAST5R||e.POSTRF||e.PREP||e.PREPR||e.UREP)&&(n.info={BOOST:e.BOOST,DPOST:e.DPOST,DREP:e.DREP,LAST5:e.LAST5,LAST5R:e.LAST5R,POSTRF:e.POSTRF,PREP:e.PREP,PREPR:e.PREPR,UREP:e.UREP,UREPR:e.UREPR}),n}},s.unblocking={applyAction:function(e,t){return e&&(e.address==t.actor&&e.removeRelation(t.address.v,"blocking"),e.address,t.address.v),e},listener:function(e,t,r){"completed"==r&&(this.applyAction(a.userInfoFull[e.actor],e),this.applyAction(a.userInfoFull[e.address.v],e),s.userInfo.cleardb(e.actor),s.userInfo.cleardb(e.address.v),h("blocking",[e.actor]))}},s.subscribe={applyAction:function(e,t){return e&&(e.address==t.actor&&(e.removeRelation({adddress:t.address.v}),e.addRelation({adddress:t.address.v})),e.address==t.address.v&&e.addRelation(t.actor,"subscribers")),e},listener:function(e,t,r){"completed"==r&&(this.applyAction(a.userInfoFull[e.actor],e),this.applyAction(a.userInfoFull[e.address.v],e),s.userInfo.cleardb(e.actor),s.userInfo.cleardb(e.address.v),h("subscribes",[e.actor]),h("subscribers",[e.address.v]))},tempAdd:function(t=[],r){return _.each(e.getAccounts(),(e=>{var s=_.filter(e.getTempActions("subscribePrivate"),r).concat(_.filter(e.getTempActions("subscribe"),r));_.each(s,(e=>{t.unshift(e)}))})),t}},s.accDel={applyAction:function(e,t){return e&&e.address==t.actor&&(e.deleted=!t.temp&&!t.relay||"temp"),e},listener:function(e,t,r){"completed"==r&&(this.applyAction(a.userInfoFull[e.actor],e),s.userInfo.cleardb(e.actor))}},s.subscribePrivate={applyAction:function(e,t){return e&&(e.address==t.actor&&(e.removeRelation({adddress:t.address.v}),e.addRelation({adddress:t.address.v,private:!0})),e.address==t.address.v&&e.addRelation(t.actor,"subscribers")),e},listener:function(e,t,r){"completed"==r&&(this.applyAction(a.userInfoFull[e.actor],e),this.applyAction(a.userInfoFull[e.address.v],e),s.userInfo.cleardb(e.actor),s.userInfo.cleardb(e.address.v),h("subscribes",[e.actor]),h("subscribers",[e.address.v]))}},s.unsubscribe={applyAction:function(e,t){return e&&(e.address==t.actor&&e.removeRelation({adddress:t.address.v}),e.address==t.address.v&&e.removeRelation(t.actor,"subscribers")),e},listener:function(e,t,r){"completed"==r&&(this.applyAction(a.userInfoFull[e.actor],e),this.applyAction(a.userInfoFull[e.address.v],e),s.userInfo.cleardb(e.actor),s.userInfo.cleardb(e.address.v),h("subscribes",[e.actor]),h("subscribers",[e.address.v]))}},s.contentDelete={applyAction:function(e,t){return e&&e.txid==t.txidEdit&&(e.deleted=!0),e},listener:function(e,t,r){"completed"==r&&(a.share[e.txidEdit]=this.applyAction(a.share[e.txidEdit],e),y("shareRequest"))}},s.upvoteShare={applyAction:function(e,t){return e&&e.txid==t.share.v&&(t.actor==r.user.address.value&&(e.myVal=Number(t.value.v)),e.scnt=(e.scnt||0)+1,e.score=(e.score||0)+Number(t.value.v)),e},listener:function(e,t,s){if("completed"==s){a.share[e.share.v]=this.applyAction(a.share[e.share.v],e);var n={data:{posttxid:e.share.v,value:e.value.v},key:e.share.v};h("postScores",[e.share.v]),h("share",[e.share.v]),e.actor==r.user.address.value&&f("myScore",[n]).then((()=>{})).catch((e=>{console.error(e)}))}},tempGet:function(t){var r=[];return _.each(e.getAccounts(),(e=>{var s=_.filter(e.getTempActions("upvoteShare"),t);_.each(s,(e=>{r.unshift(e)}))})),r}},s.myScore={keys:["myScore"],load:function(e,s,n){var a=[].concat(e,s);return S("myScore",a,(n=>{var a=_.filter(n,(t=>_.indexOf(e,t)>-1)),o=_.filter(n,(e=>_.indexOf(s,e)>-1));return t.rpc("getpagescores",[a,r.user.address.value,o]).then((e=>_.map(n,(t=>({data:_.find(e,(e=>t==(e.posttxid||e.cmntid)))||{},key:t})))))}),{fallbackIndexedDB:"myScoreFB",indexedDb:"myScore",queue:!0,queueDelay:1e3,transform:e=>this.transform(e),update:n})},transform:function({data:e,key:t}){return e.posttxid&&a.share[e.posttxid]&&(a.share[e.posttxid].myVal=Number(e.value)),e.cmntid&&a.comment[e.cmntid]&&e.myScore&&(a.comment[e.cmntid].myScore=Number(e.myScore)),e}},s.transaction={keys:["transaction"],load:function(e,s,n){return b("transaction",e,(e=>t.rpc("getrawtransaction",[e[0],1],{rpc:n}).then((t=>_.isEmpty(t)?[]:(t.confirmations||(t.confirmations=0,t.height?r.platform.currentBlock&&(t.confirmations=Math.max(r.platform.currentBlock-t.height,0)):r.platform.currentBlock&&(t.height=r.platform.currentBlock)),[{data:t,key:e[0]}])))),{update:s}).then((t=>t[e]?t[e]:Promise.reject({code:-5})))}},s.postScores={get:function(e){return n.postScores[e]||[]},keys:["postScores"],load:function(e,r){return S("postScores",e,(e=>t.rpc("getpostscores",e).then((e=>{var t=group(e,(e=>e.posttxid));return _.map(t,((e,t)=>({data:e,key:t})))})).catch((e=>Promise.reject(e)))),{indexedDb:"postScores",update:r})}},s.nameAddress={keys:["nameAddress"],load:function(e,r){return b("nameAddress",e,(r=>t.rpc("getuseraddress",[r[0]]).then((t=>t&&t[0]?[{data:t[0].address,key:e}]:Promise.reject("404")))),{indexedDb:"nameAddress",update:r}).then((t=>t[e]?t[e]:Promise.reject("404")))}},s.blocking={applyAction:function(e,t){return e&&(e.address==t.actor&&e.addRelation(t.address.v,"blocking"),e.address,t.address.v),e},keys:["blocking"],listener:function(e,t,r){"completed"==r&&(this.applyAction(a.userInfoFull[e.actor],e),this.applyAction(a.userInfoFull[e.address.v],e),this.applyAction(a.userInfoFull[e.actor],e),s.userInfo.cleardb(e.actor),s.userInfo.cleardb(e.address.v),h("blocking",[e.actor]))},load:function(e,r){return b("blocking",e,(r=>t.rpc("getuserblockings",[r[0],"1","","",0,5e3],{rpc:{fnode:"65.21.56.203:38081"}}).then((t=>t?[{data:t,key:e}]:Promise.reject("404")))),{indexedDb:"blocking",update:r}).then((t=>t[e]))}},s.subscribers={keys:["subscribers"],load:function(e,r){return b("subscribers",e,(r=>t.rpc("getusersubscribers",[r[0],"","",0,5e3]).then((t=>(t=_.map(t,(e=>e.address)))?[{data:t,key:e}]:Promise.reject("404")))),{indexedDb:"subscribers",update:r}).then((t=>t[e]))}},s.subscribes={keys:["subscribes"],load:function(e,r){return b("subscribes",e,(r=>t.rpc("getusersubscribes",[r[0],"","",0,5e3]).then((t=>(t=_.map(t,(e=>({adddress:e.adddress,private:e.private}))))?[{data:t,key:e}]:Promise.reject("404")))),{indexedDb:"subscribes",update:r}).then((t=>t[e]))}},s.search={keys:["search"],request:function(e,t){return I("search",t,e,{requestIndexedDb:"searchRequest"})}},s.searchUsers={insertFromResponseEx:function(e){return e=_.filter(e,(e=>e)),e=s.userInfo.cleanData(e),s.userInfo.insertFromResponse(e,!0).then((()=>Promise.resolve(e)))},keys:["searchUsers"],request:function(e,t){return I("searchUsers",t,e,{insertFromResponse:e=>this.insertFromResponseEx(e),requestIndexedDb:"searchUsersRequest"})}},s.tag={keys:["tag"],request:function(e,t){return I("tag",t,e,{requestIndexedDb:"tagRequest",transformResult:e=>this.transformResult(e)})},transformResult:function(e){return _.filter(_.map(e,(e=>{var t=null;try{t={count:e.count,tag:clearTagString(trim(decodeURIComponent(decodeURIComponent(e.tag))))}}catch(e){}return t})),(e=>e))}},s.clear={all:function(e,t){this.storage(e,t),this.db(e,t)},db:function(e,t){var r=s[e]?.keys||[];_.each(r,(e=>{t&&(h(e,[t]).catch((e=>{console.error(e)})),h(e+"FB",[t]).catch((e=>{console.error(e)}))),y(e+"Request").catch((e=>{console.error(e)}))}))},storage:function(e,t){var r=s[e]?.keys||[];_.each(r,(e=>{delete n[e][t],delete o[e][t]}))}},_.each(s,(e=>{e&&_.isObject(e)&&e.keys&&_.each(e.keys,(e=>{p(e)}))}));setInterval((()=>{k()}),300);s.actions.on("actionFiltered",(({action:e,address:t,status:n})=>{x={};var a=s[e.object.type]?.listener;if(a&&t==r.user.address.value){var o=e.get();if(s[e.object.type].listener(o,t,n),"completed"==n&&e.object.ustate){var i="function"==typeof o.ustate?o.ustate():o.ustate;i&&s.userState.changeLimits(t,i,1)}}})),s.storage=n,s.objects=a;return s.clearStorageAndObjects=function(){s.storage=n={},s.objects=a={},_.each(s,(e=>{e&&_.isObject(e)&&e.keys&&_.each(e.keys,(e=>{p(e)}))}))},s.ws={update:function(e,t){var r="completed",n=null;if("comment"==e){if(!t.comment)return;(n=t.comment).transaction=t.comment.id,n.actor=t.comment.address,n.optype||(n.optype=t.comment.type),s.comment.listener(n,t.addrFrom,r)}"cScore"==e&&(n={actor:t.addrFrom,comment:{v:t.commentid},value:{v:t.upvoteVal}},s.cScore.listener(n,t.addrFrom,r)),"upvoteShare"==e&&(n={actor:t.addrFrom,share:{v:t.posttxid},value:{v:t.upvoteVal}},s.upvoteShare.listener(n,t.addrFrom,r)),"subscribe"!=e&&"subscribePrivate"!=e&&"unsubscribe"!=e||(n={actor:t.addrFrom,address:{v:t.addr}},s[e].listener(n,t.addrFrom,r)),n&&_.each(s.updatelisteners,(t=>{t({alias:n,status:r,type:e},"updateListener")}))}},s.clearfromdb=h,s.clearallfromdb=y,s.updatelisteners={},s};"undefined"!=typeof module?module.exports={pSDK:pSDK}:window.pSDK=pSDK;