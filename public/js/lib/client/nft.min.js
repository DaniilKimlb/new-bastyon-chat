var NFT={},iv=[19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34];NFT.crypto={multisha:function(e,t){t||(t=100);for(var n=Buffer.from(e),r=0;r<t;r++)n=bitcoin.crypto.sha256(n);return n.toString("hex")},secret:function(e,t){return this.multisha(this.multisha(e)+"_"+t,10)},content:{encrypt:function(e,t,n){return NFT.crypto.aeswc.encrypt(e,t,n)},decrypt:function(e,t,n){return NFT.crypto.aeswc.decrypt(e,t,n)}},aeswc:{keys:function(e){var t=new PBKDF2(key,"NFT.crypto.aeswc",64,128);return new Promise(((e,n)=>{t.deriveKey(null,(function(t){e(t)}))}))},encrypt:function(e,t,n){if(!e||!t)return Promise.reject("data");n||(n={}),n.charsetEnc=n.charsetEnc||"utf8",n.charsetDec=n.charsetDec||"hex";var r=aesjs.utils[n.charsetEnc].toBytes(e);return NFT.crypto.aeswc.keys(t).then((e=>crypto.subtle.encrypt({name:"AES-CBC",iv:new Uint8Array(iv)},e,r))).then((function(e){return Promise.resolve(aesjs.utils[n.charsetDec].fromBytes(new Uint8Array(e)))}))},decrypt:function(e,t,n){if(!e||!t)return Promise.reject("data");n||(n={}),n.charsetEnc=n.charsetEnc||"utf8",n.charsetDec=n.charsetDec||"hex";var r=new Uint8Array(aesjs.utils[n.charsetDec].toBytes(e));return NFT.crypto.aeswc.keys(t).then((e=>crypto.subtle?crypto.subtle.decrypt({name:"AES-CBC",iv:new Uint8Array(iv)},akey,r):Promise.reject("crypto.subtle"))).then((function(e){return Promise.resolve(aesjs.utils[n.charsetEnc].fromBytes(new Uint8Array(e)))}))}}},NFT.contentItem=function(e){var t=this,n={type:null,size:0,name:""},r=null,c=null,o=!1,i="";return t.clbks={encryption:{}},t.emit=function(e){_.each(content.clbks[e],(function(e){e(t)}))},t.destroy=function(){_.each(content.clbks,(function(e,t){content.clbks[t]={}})),n={type:null,size:0,name:""},r=null,c=null,o=!1,i=""},t.export=function(e){return r?{data:r,decrypted:e?"":o?c:"",meta:_.clone(n),encryption:o,hash:i}:null},t.data=function(){return r},t.hash=function(){return i},t.encrypted=function(){return o},t.decrypted=function(){return c},t.import=function(e){n=_.clone(n),i=e.hash,e.decrypted&&(c=e.decrypted),r=e.data,(o=e.encryption)||(c=r)},t.decrypt=function(e){return c?Promise.resolve():NFT.crypto.content.decrypt(r,e).then((e=>(c=e,t.emit("decryption"),Promise.resolve(c))))},t.add=function(e,r,o){return r||(r={}),e?r.type?(c=e,n.size=r.size||0,n.type=r.type||null,n.name=r.name||"",i=NFT.crypto.multisha(c,10),t.setEncryption(o)):Promise.reject("emptytype"):Promise.reject("emptydata")},t.checkhash=function(){return NFT.crypto.multisha(c,10)==i},t.setEncryption=function(n){return o=!!n,r=null,c&&i?o?NFT.crypto.content.encrypt(c,e.secret(i)).then((e=>(r=e,t.emit("encryption"),Promise.resolve(o)))):(r=c,t.emit("encryption"),Promise.resolve(o)):(o=!1,Promise.reject("unable"))},t},NFT.content=function(e){return this.import=function(){},this},NFT.create=function(e){var t=this,n=[],r={name:"",description:"",author:""},c="";return r.author=e.address(),t.set=function(e,n){return void 0===r[e]?Promise.reject("metakey"):(r[e]=encodeURI(n),t.reencrypt())},t.addtoitems=function(e){t.removefromitems(e.content.hash()),n.push(e),e.content.clbks.encryption.parent=t.reencrypt},t.removefromitems=function(e){n=_.filter(n,(function(t){return e!=t.content.hash()||!1}))},t.find=function(e){return _.find(n,(function(t){return e==t.content.hash()}))},t.add=function(n,r,c){var o=new NFT.contentItem(e);return o.add(n,r,c).then((e=>o.data?(t.addtoitems({content:o,encryptedSecret:null}),Promise.resolve()):Promise.reject("dataempty"))).then((e=>t.reencrypt()))},t.remove=function(e){var n=t.removefromitems(e);return n&&n.destroy(),t.reencrypt()},t.commonhash=function(){var e=r.name+r.description+r.author;return _.each(n,(function(t,n){e+=n})),e?NFT.crypto.multisha(e,100):""},t.commonhashcalc=function(){c=t.commonhash(),_.each(n,(function(e){e.secret=null}))},t.reencrypt=function(){return t.commonhashcalc(),t.encryptallsecrets()},t.encryptallsecrets=function(){var e=_.map(n,(function(e){return t.encryptsecret(e.content).then((t=>(e.encryptedSecret=t,Promise.resolve(e))))}));return Promise.all(e)},t.encryptsecret=function(t){if(!c)return Promise.reject("hash");if(!t.encrypted())return Promise.resolve(null);var n=e.secret(t.hash());return NFT.crypto.content.encrypt(n,e.secret(c)).then((e=>Promise.resolve(e)))},t.destroy=function(){r={name:"",description:"",author:""},n=[],t.reencrypt()},t.decryptsecret=function(t,n){return c?decryptedSecret?NFT.crypto.content.decrypt(t,n||e.secret(c)).then((e=>Promise.resolve(e))):Promise.resolve(null):Promise.reject("hash")},t.export=function(e){var o=t.validation();if(o&&e)return Promise.reject(o);var i={meta:{name:r.name,description:r.description,author:r.author},hash:c,items:_.map(n,(function(t){return{content:t.content.export(e),encryptedSecret:t.encryptedSecret}}))};return Promise.resolve(i)},t.addImport=function(n){var r=new NFT.contentItem(e);r.import(n.content),t.addtoitems({content:r,encryptedSecret:n.encryptedSecret||null})},t.import=function(e){t.destroy(),r={name:e.meta.name,description:e.meta.description,author:e.meta.author},c=e.hash,_.each(e.items,t.addImport)},t.decrypt=function(o){r.author==e.address()&&(o=e.secret(c));var i=_.map(n,(function(e){return e.encryptedSecret?t.decryptsecret(e.encryptedSecret,o).then((t=>e.content.decrypt(t))).then((e=>Promise.resolve())):e.content.encrypted()?Promise.reject("encryptedSecret"):Promise.resolve()}));return Promise.all(i)},t.validation=function(){return r.name?r.description?r.author?!!_.find(n,(function(e){if(!e.content)return!0;var t=e.content.get();return!t.data||(!t.hash||(!(!t.encryption||e.secret)||(!(t.encryption||!e.secret)||void 0)))}))&&"item":"meta.author":"meta.description":"meta.name"},t},NFT.instance=function(e){var t=this,n=t.app.user.keys().privateKey.toString("hex");return t.platform=e,t.address=function(){var e=t.sdk.address.pnet();return e?e.address:""},t.secret=function(e){return e?NFT.crypto.secret(n,e):null},t.create=function(){return new NFT.create(t)},t.content=function(){return new NFT.content(t)},t},"undefined"!=typeof module?module.exports={NFT:NFT}:window.NFT=NFT;