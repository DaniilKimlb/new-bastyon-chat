var ActionOptions={pcTxFee:1e-8,amountC:1e8,dustValue:7e-6,optimizeUnspentsMin:80,optimizeUnspentsMax:300,clearRejected:!0,clearCompleted:!0,objects:{transaction:{calculateFee:function(){return!0},rejectedAsk:!0,donotexport:!0,amount:function(e){return _.reduce(e.object.reciever.v,((e,t)=>e+t.amount),0)},validation:function(e){return e.object.reciever.v&&e.object.reciever.v.length},destination:function(e){return _.clone(e.object.reciever.v)},opreturn:function(e,t){if(e.object.message.v)return e.object.message.v},addresses:function(e){return _.clone(e.object.source.v)},feemode:function(e,t){if(e.object.feemode.v)return e.object.feemode.v}},upvoteShare:{collision:function(e,t){return!(e.object.type==t.object.type&&t.object.share.v==e.object.share.v&&t.added<e.added)}},subscribePrivate:{collision:function(e,t){return"unsubscribe"!=t.object.type&&"subscribe"!=t.object.type||t.object.address.v!=e.object.address.v||!(t.added<e.added)}},subscribe:{collision:function(e,t){return"unsubscribe"!=t.object.type&&"subscribePrivate"!=t.object.type||t.object.address.v!=e.object.address.v||!(t.added<e.added)}},unsubscribe:{collision:function(e,t){return"subscribe"!=t.object.type&&"subscribePrivate"!=t.object.type||t.object.address.v!=e.object.address.v||!(t.added<e.added)}},userInfo:{rejectedAsk:!1,sendAgain:!0,attentionIfReJectCodes:[18],change:function(e,t){e.transaction&&(t.willChange=!0),e.completed&&(t.willChange=!1,t.status.value=!0)},sendWithNullStatus:!0,collision:function(e,t){return!(e.object.type==t.object.type&&!t.sent&&t.added<e.added)},priority:1},share:{rejectedAsk:!0,priority:2},contentBoost:{rejectedAsk:!0,amount:function(e){return e.object.amount.v},destination:function(e){return[]},burn:!0},comment:{rejectedAsk:!0,destination:function(e){return"comment"!=e.object.typeop()?[]:_.clone(e.object.donate.v)},amount:function(e){return"comment"!=e.object.typeop()?0:_.reduce(e.object.donate.v,((e,t)=>e+t.amount),0)},calculateFee:function(e){return e.object.donate.v>0},collision:function(e,t){return!(e.object.typeop()==t.object.typeop()&&"commentEdit"==e.object.typeop()&&t.object.id==e.object.id&&t.added<e.added)}}}},errorCodesAndActionsExecutors={wait:function(e){return e.rejectWait=(new Date).addSeconds(120),Promise.resolve()},useraction:function(e){},limit:function(e,t){return Promise.reject(t)}},errorCodesAndActions={1:errorCodesAndActionsExecutors.wait,261:errorCodesAndActionsExecutors.wait,2:errorCodesAndActionsExecutors.limit,3:errorCodesAndActionsExecutors.limit,15:errorCodesAndActionsExecutors.limit,29:errorCodesAndActionsExecutors.limit,31:errorCodesAndActionsExecutors.limit,49:errorCodesAndActionsExecutors.limit,61:errorCodesAndActionsExecutors.limit,65:errorCodesAndActionsExecutors.limit,18:errorCodesAndActionsExecutors.useraction,28:errorCodesAndActionsExecutors.wait,37:errorCodesAndActionsExecutors.wait},Action=function(e,t,n,r){var o=ActionOptions.objects[t.type]||{},s="",i=this;i.object=t,i.priority=n||o.priority||3,i.added=new Date,i.until=(new Date).addSeconds(43200),i.settings=r||{},i.rejectWait=null,i.updated=null,i.sent=null,i.checkedUntil=null,i.checkConfirmationUntil=null,i.inputs=[],i.outputs=[],i.attempts=0,i.alias=null,i.transaction=null,i.completed=!1,i.rejected=null,i.tryingsend=null,i.id=makeid(),i.export=function(){var e={};return e.id=i.id,e.priority=i.priority,e.added=i.added,e.until=i.until,e.sent=i.sent,e.sending=i.sending,e.checkedUntil=i.checkedUntil,e.checkConfirmationUntil=i.checkConfirmationUntil,e.inputs=_.clone(i.inputs),e.outputs=_.clone(i.outputs),e.attempts=i.attempts,e.transaction=i.transaction,e.settings=i.settings,e.rejectWait=i.rejectWait,e.rejected=i.rejected,e.completed=i.completed,e.tryingsend=i.tryingsend,e.updated=i.updated,i.object.export?e.expObject=i.object.export(!0):e.object=_.clone(i.object),e},i.import=function(e){if(e.updated&&new Date(e.updated)<i.updated)return;if(i.priority=e.priority,e.added&&(i.added=new Date(e.added)),e.until&&(i.until=new Date(e.until)),e.sent&&(i.sent=new Date(e.sent)),e.sending&&(i.sending=new Date(e.sending)),e.rejectWait&&(i.rejectWait=new Date(rejectWait)),e.checkedUntil&&(i.checkedUntil=new Date(e.checkedUntil)),e.tryingsend&&(i.tryingsend=new Date(e.tryingsend)),e.updated&&(i.updated=new Date(e.updated)),i.id=e.id||makeid(),e.checkConfirmationUntil&&(i.checkConfirmationUntil=new Date(e.checkConfirmationUntil)),i.inputs=_.clone(e.inputs),i.outputs=_.clone(e.outputs),i.attempts=e.attempts,i.transaction=e.transaction,i.settings=e.settings||{},e.object&&(i.object=e.object),e.completed&&(i.completed=e.completed),e.rejected&&(i.rejected=e.rejected),e.expObject){var t=new kits.c[e.expObject.type];t.import(e.expObject),i.object=t}o=ActionOptions.objects[i.object.type]||{},i.options=o,s=d()},i.logerror=function(t){try{e.parent.app.Logger.error({err:"TRANSACTION_ERROR",code:802,payload:t})}catch(e){console.error("cant send error log")}};var a=function(){u()&&e.save()},c=function(){u()&&e.trigger(i)},d=function(){var e=i.export();return delete e.updated,rot13(JSON.stringify(e))},u=function(){var e=d();if(s!=e)return i.updated=new Date,s=e,!0},l=function(t){if(o.addresses){var n=o.addresses(i,e);t=_.filter(t,(e=>_.indexOf(n,e.address)>-1))}else t=_.filter(t,(t=>t.address==e.address));return t},p=async function(t,n,r){var s=o.addresses?o.addresses(i,e):[e.address];s.length||(s=[e.address]);var d=l(e.getActualUnspents("userInfo"!=i.object.type||"withUnconfirmed",s)),u=n||(o.calculateFee&&o.calculateFee(i)?0:ActionOptions.pcTxFee);if(i.estimatedFee=u,!d.length||t)try{await e.updateUnspents(t?0:60).then((t=>{if(!(t=l(t)).length&&!e.unspents.willChange&&e.actualBalance().total<=0)return e.unspents.updated?Promise.reject("actions_noinputs"):Promise.reject("actions_inputs_not_updated");d=e.getActualUnspents("userInfo"!=i.object.type||"withUnconfirmed",s)}))}catch(e){return Promise.reject(e)}if(!d.length)return Promise.reject("actions_noinputs_wait");var f=o.amount?o.amount(i):0,m=!1;o.burn||(f+=o.feemode&&"include"==o.feemode(i,e)?0:u,m=!0);var h=function(e,t){var n=!1;0==t&&(t=1e-8),t<1e-7&&e.length>ActionOptions.optimizeUnspentsMax&&(n=!0);var r=0,o={},s=ActionOptions.dustValue;for(_.reduce(e,((e,t)=>e+t.amount),0)<s&&(console.error("DUST: Unable sent"),s=0);(r<s||r<t||n&&_.toArray(o).length<5)&&e.length;){var i=Math.max(Math.max(t,s)-r,0),a=_.first(_.sortBy(e,(e=>Math.abs(e.amount-i))),5),c=a[rand(0,a.length-1)];o[c.txid+":"+c.vout]=c,r+=c.amount,e=_.filter(e,(e=>!o[e.txid+":"+e.vout]))}return _.toArray(o)}(d,f),v=toFixed(_.reduce(h,((e,t)=>e+t.amount),0),8),j=toFixed(v-u,8);if(f&&v<f)return m?e.actualBalance(s).total<f?Promise.reject("actions_totalAmountSmaller_amount_fee"):Promise.reject("actions_totalAmountSmaller_amount_fee_wait"):e.actualBalance(s).total<f?Promise.reject("actions_totalAmountSmaller_amount"):Promise.reject("actions_totalAmountSmaller_amount_wait");if(j<=0)return Promise.reject("actions_totalAmountZero");var g=[],w=null,A=null,y=null,b="sendrawtransaction";if(i.object.serialize){b="sendrawtransactionwithmessage";var x=Buffer.from(bitcoin.crypto.hash256(i.object.serialize()),"utf8");w=i.object.typeop?i.object.typeop():i.object.type,A=i.object.optstype&&i.object.optstype()?i.object.optstype():w,y=[Buffer.from(w,"utf8"),x],i.object.opreturn&&y.push(Buffer.from(i.object.opreturn()))}else if(o.opreturn){var k=o.opreturn(i,e);k&&(y=[Buffer.from(k,"utf8")])}if(o.destination)_.each(o.destination(i,e),(e=>{g.push(_.clone(e))}));else if(d.length<ActionOptions.optimizeUnspentsMin&&j>.001){var U=2;j>.5&&!e.wasdvii&&(U=10,e.wasdvii=!0);for(var C=toFixed(j/U,8),P=0,S=0;S<U;S++)if(S==U-1){let e=toFixed(j-P,8);g.push({address:s[0],amount:e}),P+=e}else P+=C,g.push({address:s[0],amount:C})}else g.push({address:s[0],amount:j});if(o.feemode&&"include"==o.feemode(i,e)){var I=u/g.length;_.each(g,(e=>{e.amount=toFixed(e.amount-I,8)}))}var D=toFixed(_.reduce(g,((e,t)=>e+t.amount),0),8);if(D<j){var F=toFixed(j-D-(o.burn?f:0),8);F>1/ActionOptions.amountC&&g.push({address:s[0],amount:F})}var O=null;try{O=function({inputs:t,outputs:n,opreturnData:r}){var o=new bitcoin.TransactionBuilder;if(o.addNTime(e.parent.app.platform.timeDifference||0),_.each(t,((e,t)=>{o.addInput(e.txid,e.vout,null,Buffer.from(e.scriptPubKey,"hex"))})),r){var s=bitcoin.payments.embed({data:r});o.addOutput(s.output,0)}return _.each(n,(e=>{o.addOutput(e.address,Math.floor(e.amount*ActionOptions.amountC))})),_.each(t,((t,n)=>{e.signInput(o,t,n)})),o.build()}({inputs:h,outputs:g,opreturnData:y})}catch(e){return Promise.reject(e)}if(o.calculateFee&&o.calculateFee(i)&&!n){var B=await e.parent.estimateFee();return p(!1,Math.min(O.virtualSize()*B,.0999),r)}var T=O.toHex();if(!r)return Promise.resolve({tx:O,calculatedFee:n});var N=[T];return i.object.export&&!o.donotexport&&N.push(i.object.export()),A&&N.push(A),i.sending=new Date,i.inputs=h,i.outputs=g,c(),e.parent.api.rpc(b,N).then((e=>(i.transaction=e,i.checkConfirmationUntil=(new Date).addSeconds(35),delete i.sending,i.sent=new Date,c(),Promise.resolve()))).catch(((e={})=>{var o=e.code;if(delete i.inputs,delete i.outputs,delete i.sending,-26==o||-25==o||16==o||261==o){if(!t)return a(),p(!0,n,r);i.logerror({method:b,parameters:N,error:e})}return 26==o&&i.logerror({method:b,parameters:N,error:e}),i.rejected=o||(e.toString?e.toString():"actions_rejected"),c(),Promise.reject(i.rejected)}))};return i.controlReject=function(e){return e||(e=i.rejected),!e||(!!(e&&i.options.attentionIfReJectCodes&&_.indexOf(i.options.attentionIfReJectCodes,e)>-1)||!(!e||!errorCodesAndActions[e]))},i.checkTransactionWide=async function(){var t=0;return e.parent.app.platform.sdk.node.transactions.get.txwide(i.transaction,((e={})=>{_.each(e,(e=>{e.data&&e.data.confirmations>0&&t++,e.error&&(-5!=e.error.code&&-8!=e.error.code||t--)}))})).then((()=>t>0?1:0==t?0:t<0?-1:void 0))},i.sendAgain=function(){delete i.rejected,c()},i.rejectedByUser=function(){i.rejected="actions_rejectedByUser",c()},i.setCompleted=function(){delete i.rejected,i.completed=!0,c()},i.trysend=function(e){i.tryingsend=e?(new Date).addSeconds(45):null,a()},i.processing=async function(){if(i.completed)return Promise.reject("actions_completed");if(i.rejected&&(i.rejectWait&&i.rejectWait>new Date&&(i.rejectWait=null,i.rejected=null),i.rejected))return Promise.reject(i.rejected);if(i.transaction)return i.checkConfirmationUntil&&i.checkConfirmationUntil>new Date?Promise.reject("actions_alreadyCheckConfirmation"):(i.checkConfirmationUntil=(new Date).addSeconds(65),new Promise(((t,n)=>{retry((function(){return e.parent.app.platform.currentBlock}),(function(){e.parent.app.platform.sdk.node.transactions.get.tx(i.transaction,((r,s={})=>(r||(r={}),-5==s.code||-8==s.code?(i.attempts||(i.attempts=0),i.attempts++,i.attempts>2?(o.rejectedAsk||o.sendAgain?i.rejected="actions_rejectedFromNodes":(i.sent=null,i.transaction=null,i.rejected="actions_rejectedFromNodes_ignore"),o.change&&o.change(i,e),c(),n(i.rejected)):n("newAttempt")):r.confirmations>0?(i.completed=!0,o.change&&o.change(i,e),e.addUnspentFromTransaction(r),e.removeInputsFromTransaction(r),c(),t()):n("actions_waitConfirmation"))))}))})));if(i.sent)return Promise.reject("actions_alreadySent");if(i.sending&&(new Date).addSeconds(-365)<i.sending)return Promise.reject("actions_alreadySending");if(i.tryingsend&&i.tryingsend>new Date)return Promise.reject("actions_tryingsend");if(i.until<new Date)return i.rejected="actions_rejectedByTime",Promise.reject(i.rejected);if(!e.status.value&&!o.sendWithNullStatus)return Promise.reject("actions_waitUserStatus");if(i.object.checkloaded&&i.object.checkloaded())return Promise.reject("actions_resourses");if(i.object.validation){var t=i.object.validation();if(t)return i.rejected=t,Promise.reject(i.rejected)}return o.validation&&!o.validation(i)?(i.rejected="validation",Promise.reject(i.rejected)):(i.trysend(!0),i.object.canSend?i.checkedUntil&&i.checkedUntil>new Date?Promise.reject("actions_alreadyCheck"):(i.checkedUntil=(new Date).addSeconds(45),new Promise(((e,t)=>{i.object.canSend(app,(n=>{n?(i.checkedUntil=null,p(!1,(i.settings||{}).calculateFee||null,!0).then(e).catch(t)):t("actions_checkFail")}))})).then((()=>{i.trysend()})).catch((e=>(i.trysend(),Promise.reject(e))))):p(!1,(i.settings||{}).calculateFee||null,!0).then((()=>{i.trysend()})).catch((e=>(i.trysend(),Promise.reject(e)))))},i.processingWithIteractions=async function(t){var n=null,r=!1;try{await i.processing()}catch(e){("actions_rejectedFromNodes"==e||"actions_noinputs"==e||i.controlReject(e))&&(r=!0),i.currentState=e,n=e}if(n&&r?n=await e.actionRejectedWithTriggers(i,n):(t&&("actions_inputs_not_updated"==n||"actions_noinputs_wait"==n||"actions_userInteractive"==n||"actions_waitUserInteractive"==n||"actions_waitUserStatus"==n||"actions_tryingsend"==n||"actions_checkFail"==n||(i.rejected=n)),c()),n)throw n},i.prepareTransaction=function(e=0){return p(!1,e,!1)},i.get=function(){var t=i.export(),n={};return i.object.alias?n=i.object.alias():t.expObject?(n=new kits.c[t.expObject.type]).import(t.expObject):n=_.clone(t.object),n.txid=t.transaction,!n.txid||i.completed||i.rejected||(n.temp=!0),n.txid||(n.txid=i.id,n.relay=!0),n.actor=e.address,n.type=i.object.type,n.id||(n.id=n.txid),n.address||(n.address=e.address),n.time=new Date,n.timeUpd=n.time,n.optype=i.object.typeop?i.object.typeop():i.object.type,n.inputs=t.inputs,n.outputs=t.outputs,n.txidEdit&&(n.txid=n.txidEdit,n.editing=!0),i.checkedUntil&&(n.checkSend=!0),n.actionId=i.id,i.rejected&&(n.rejected=i.rejected),n.__action=i,n},i.options=o,i.makeTransaction=p,i.setUpdated=u,i},Account=function(e,t){var n=this,r=null,o=null;n.waitUserAction=null,n.address=e,n.status={value:null,updated:null,willChange:!1},n.unspents={willChange:null,value:[],updated:null,height:0},n.actions={value:[],updated:null};var s={completed:{},rejected:{},sent:{},relay:{},relayorsent:{}};n.keyPair=null;var i={unspents:null},a=function(e){n.waitUserAction=e,o=e,n.trigger()};n.clearThisWaitUserAction=function(){o&&a(null)};var c=function(e){var t=[];return _.each(e,(e=>{var r=_.find(n.actions.value,(t=>{if(!t.rejected&&!t.completed)return t.transaction==e||void 0}));r&&(r.completed=!0,t.push(r),r.options.change&&r.options.change(r,n),n.trigger(r)),n.unspents.willChange&&n.unspents.willChange.transaction==e&&(n.unspents.willChange=null)})),t},d=function(){n.unspents.value=_.uniq(n.unspents.value,(e=>e.txid+";"+e.vout))},u=function(e){var t=0;return e.confirmations<=11&&e.pockettx&&(t=11-e.confirmations),0!=e.confirmations||e.coinbase||e.coinstake||e.pockettx||(t=1),e.confirmations<100&&(e.coinbase||e.coinstake)&&(t=100-e.confirmations),!t},l=function(e){return _.find(n.actions.value,(t=>t.id==e))};n.releaseCheckInAnotherSession=function(){_.each(n.actions.value,(e=>{delete e.checkInAnotherSession})),n.checkRequestUnspentsInAnotherSession=!1},n.cancelAction=function(e){var t=l(e);return t?(t.rejected="actions_rejectedByUser",n.trigger(t),Promise.resolve()):Promise.reject("actions_noAction")},n.isCurrentAccount=function(){var e=t.getCurrentAccount();return!!e&&e.address==n.address},n.actionRejectedWithTriggers=async function(e,t){try{await n.actionRejected(e,t),n.trigger(e),t=null}catch(r){"actions_rejectedByUser"==r&&(n.rejected="actions_rejectedByUser",n.trigger(e)),t=r}return t},n.actionRejected=async function(e,t){if(e.checkInAnotherSession)return Promise.reject(t);if("actions_noinputs"==t){if(n.checkRequestUnspentsInAnotherSession)return Promise.reject(t);var r={reason:""};return"userInfo"==e.object.type&&"registered"!=n.getStatus()?r.reason="registration":r.reason="balance",await n.userInteractive(e,t,"requestUnspents",r).catch((t=>{e.checkInAnotherSession=!0,n.checkRequestUnspentsInAnotherSession=!0}))}if("actions_rejectedFromNodes"==t){if(!e.options.sendAgain&&!e.options.rejectedAsk)return void e.rejectedByUser();if(!e.sent||!e.transaction)return;if(e.sent>(new Date).addSeconds(-1200))return;try{var o=await e.checkTransactionWide();if(o>1)return void e.setCompleted();if(0==o)return void(e.checkInAnotherSession=!0)}catch(t){return void(e.checkInAnotherSession=!0)}if(e.options.sendAgain)return void e.sendAgain();if(e.options.rejectedAsk)return n.userInteractive(e,t,"sendTransactionAgainQuestion",{}).then((()=>{e.sendAgain()})).catch((t=>{"actions_rejectedByUser"==t||"todo"==t?e.rejectedByUser():e.checkInAnotherSession=!0}))}if(e.controlReject(t)){if("userInfo"==e.object.type&&18==t)return await n.userInteractive(e,t,"changeUserName",{}).then((()=>{})).catch((t=>{"actions_rejectedByUser"==t?e.rejectedByUser():e.checkInAnotherSession=!0}));if(errorCodesAndActions[t])return errorCodesAndActions[t](e,t).then((()=>Promise.resolve()))}return Promise.reject(t)},n.userInteractive=function(e,o,s,i){return n.isCurrentAccount()?n.waitUserAction?Promise.reject("actions_waitUserInteractive"):(a({action:e.id,error:o}),"requestUnspents"==s?n.requestUnspents(i).then((()=>Promise.resolve())).finally((()=>{a(null)})):"sendTransactionAgainQuestion"==s?(a(null),Promise.reject("todo")):"changeUserName"==s?t.app.platform.ui.edituserinfo(s,(e=>{r=e})).then((e=>Promise.resolve(e))).catch((e=>"registered"==n.getStatus()?Promise.reject("actions_rejectedByUser"):Promise.reject(e))).finally((()=>{a(null)})):void a(null)):Promise.reject("actions_userInteractive")},n.solveCaptcha=function(e={},n){return t.app.platform.ui.captcha(e.reason,(e=>{r=e}),n)},n.support=function(e,n,r){var o={...e,error:n,...r};return t.app.platform.ui.support(e.reason,o)},n.willChangeUnspentsCallback=function(e,t){n.unspents.willChange={transaction:null,id:e,until:(new Date).addSeconds(280),proxy:t},n.trigger()},n.checkWillChangeUnspents=function(){n.unspents.willChange&&new Date>n.unspents.willChange.until&&(n.unspents.willChange=null,n.trigger())},n.requestUnspents=function(e,r){return new Promise(((e,n)=>{if(r)return e(r);t.api.get.proxywithwalletls().then((e=>{r={proxy:e.id}})).then(e).catch(n)})).then((()=>n.solveCaptcha(e,r))).then((o=>t.api.fetchauth("free/balance",{address:n.address,captcha:o.id,key:e.reason},r))).then((e=>(n.willChangeUnspentsCallback(e,r.proxy),Promise.resolve({action:e,proxy:r.proxy})))).catch((t=>(console.error(t),"captcha"==t?n.requestUnspents(e,r):"noproxywithwallet"==t||"error"==t||"iplimit"==t||"uniq"==t?(n.support(e,t,r),Promise.reject(t)):Promise.reject(t)))).catch((e=>Promise.reject(e)))},n.setStatus=function(e){n.status.value=!!e},n.setKeys=function(e){n.keyPair=e},n.checkTransactionById=function(e){c(e).length&&n.loadUnspents()},n.removeInputsFromTransaction=function(e){n.unspents.value=_.filter(n.unspents.value,(t=>{if(!_.find(e.vin,(e=>t.txid==e.txid&&t.vout==e.vout)))return!0}))},n.addUnspentFromTransaction=function(e){var r=_.map(e.vout,(n=>({address:deep(n,"scriptPubKey.addresses.0"),amount:n.value,vout:n.n,height:e.height,scriptPubKey:deep(n,"scriptPubKey.hex"),confirmations:Math.max(e.confirmations||(e.height&&t.app.platform.currentBlock?t.app.platform.currentBlock-e.height:0),0),pockettx:""==deep(e,"vout.0.scriptPubKey.addresses.0"),coinbase:!1,txid:e.txid}))),o=(t.app.platform.sdk.addresses.storage.addresses||[]).concat(n.address);r=_.filter(r,(e=>!!e.address&&_.find(o,(t=>t==e.address)))),_.each(r,(e=>{n.unspents.willChange&&n.unspents.willChange.transaction==e.txid&&(n.unspents.willChange=null),n.unspents.value.push(e)})),d()},n.isCurrentNetwork=function(){return!(0!=n.address.indexOf("T")||!window.testpocketnet)||0==n.address.indexOf("P")&&!window.testpocketnet},n.clear=function(){n.unspents={willChange:null,value:[],updated:null},n.actions.value=_.filter(n.actions,(e=>!e.completed&&!e.rejected)),_.each(n.actions.value,(e=>{e.rejectedByUser()})),n.save()},n.export=function(){var e={};return e.status=_.clone(n.status),e.unspents=_.clone(n.unspents),e.waitUserAction=_.clone(n.waitUserAction),e.actions={updated:n.actions.updated,value:[]},_.each(n.actions.value,(t=>{e.actions.value.push(t.export())})),e},n.import=function(e,t){n.status=e.status,!e.unspents.updated||!n.unspents.updated&&n.unspents.updated||(!n.unspents.updated||new Date(e.unspents.updated)>n.unspents.updated)&&(n.unspents=e.unspents,n.unspents.updated=new Date(e.unspents.updated)),e.actions.updated&&(n.actions.updated=new Date(e.actions.updated)),n.waitUserAction=e.waitUserAction||null,n.unspents.willChange&&(n.unspents.willChange.until=new Date(n.unspents.willChange.until)),_.each(e.actions.value,(e=>{if(!(new Date(e.until)<new Date||e.completed&&n.emitted.completed[e.id]))if("withcompleted"!=t&&e.completed&&ActionOptions.clearCompleted||e.rejected&&"actions_rejectedFromNodes"!=e.rejected&&"actions_checkFail"!=e.rejected&&"newAttempt"!=e.rejected&&!errorCodesAndActions[e.rejected]&&ActionOptions.clearRejected)_.each(n.emitted,(t=>{e.id&&t[e.id]&&delete t[e.id]}));else try{var r=_.find(n.actions.value,(t=>t.id==e.id)),o=r||new Action(n,{});o.import(e),r||n.actions.value.push(o)}catch(e){}})),n.waitUserAction?n.actionRejectedWithTriggers(n.waitUserAction.action,n.waitUserAction.error).catch((e=>{})):r&&(r.destroy(),r=null)},n.signInput=function(e,r,o){if(0!=r.address.indexOf("T")&&0!=r.address.indexOf("P"))if("htlc"!=r.type)if(0!=r.address.indexOf("Z")&&0!=r.address.indexOf("Y"));else{if(t.app.user.address.value!=n.address)throw"unableSign:3";var s=_.indexOf(t.app.platform.sdk.addresses.storage.addresses,r.address);if(!(s>-1))throw"unableSign:4";var i=t.app.platform.sdk.addresses.storage.addressesobj[s],a=t.app.platform.sdk.address.dumpKeys(s);try{e.sign({prevOutScriptType:"p2sh-p2wpkh",redeemScript:i.redeem.output,vin:o,keyPair:a,witnessValue:Number((ActionOptions.amountC*r.amount).toFixed(0))})}catch(e){throw"unableSign:5"}}else{if(!(c=t.app.user.address.value!=r.address?n.keyPair:t.app.user.keys()))throw"unableSign:2";e.sign({prevOutScript:Buffer.from(r.scriptPubKey,"hex"),prevOutScriptType:"htlc",vin:o,keyPair:c})}else{var c;if(!(c=t.app.user.address.value!=r.address?n.keyPair:t.app.user.keys()))throw"unableSign:1";e.sign(o,c)}},n.updateUnspents=function(e){if(void 0===e&&(e=600),i.unspents)return i.unspents;if(n.unspents.updated&&n.unspents.updated.addSeconds(e)>new Date)return Promise.resolve(n.unspents.value);return n.loadUnspents()},n.loadUnspents=function(){if(!n.isCurrentNetwork())return Promise.reject("otherNetwork");if(i.unspents)return i.unspents;var e=n.address==window.app.user?.address.value&&t.app.platform.sdk.addresses.storage.addresses||[],r=t.api.rpc("txunspent",[[n.address].concat(e),1,9999999]).then((e=>(delete i.unspents,!e.length&&n.unspents.value&&n.unspents.value.length>2&&(!n.unspents.buganswer||n.unspents.buganswer<50)?(n.unspents.buganswer||(n.unspents.buganswer=0),n.unspents.buganswer++,Promise.resolve(n.unspents.value)):(delete n.unspents.buganswer,_.each(n.unspents.value,(e=>{var t=_.find(n.actions.value,(t=>{if(!t.completed&&!t.rejected)return t.transaction==e.txid||void 0}));t&&(t.completed=!0,t.change&&t.change(t,n),n.trigger(t))})),n.unspents.value=e,n.unspents.updated=new Date,n.unspents.height=app.platform.currentBlock||0,d(),n.trigger(),Promise.resolve(e))))).catch((e=>{console.error("action",e),delete i.unspents}));return i.unspents=r,r},n.ws={transaction:function(e){e.height<n.unspents.height||t.app.platform.sdk.node.transactions.get.tx(e.txid,((t,r={})=>{n.addUnspentFromTransaction(t),n.removeInputsFromTransaction(t),c([e.txid]),n.trigger()}))},block:function(e){_.each(n.unspents.value,(t=>{e.difference>0?t.confirmations=t.confirmations+e.difference:t.confirmations++}))}},n.getActualUnspents=function(e,t){var r=n.unspents.value;return t&&(_.isArray(t)||(t=[t]),r=_.filter(r,(e=>_.indexOf(t,e.address)>-1))),_.filter(r,(t=>!(e&&"withUnconfirmed"!=e&&!u(t))&&(!_.find(n.actions.value,(e=>!e.rejected&&!e.completed&&(!!_.find(e.inputs,(e=>e.txid==t.txid&&e.vout==t.vout))||void 0)))||void 0)))};var p=null;n.processing=async function(){if(!p&&(n.checkWillChangeUnspents(),!n.waitUserAction))if(n.isCurrentNetwork()){var e=_.sortBy(n.actions.value,(e=>e.priority));p=processArray(e,(e=>e.processingWithIteractions().catch((e=>(console.error(e,"processingWithIteractions"),Promise.resolve()))))).finally((()=>{setTimeout((()=>{p=null}),1e3)}))}else console.log("!isCurrentNetwork")},n.checkAccountReadySend=function(e){if(n.status.value&&n.unspents.value.length&&n.isCurrentNetwork())return!0},n.addAction=function(e,t,r){var o=new Action(n,e,t,r);return o.options.collision&&_.each(n.actions.value,(e=>{e.transaction||e.sent||e.completed||e.rejected||e.rejectWait||o.options.collision(o,e)||(e.rejected="actions_collision",n.trigger())})),n.actions.value.push(o),o},n.prepareAction=function(e,t){return new Action(n,e,t)},n.getActions=function(e,t){return _.map(_.filter(n.actions.value,(n=>!(t&&!t(n))&&(!e||n.object.type==e))),(e=>e))},n.getTempActions=function(e,t,r){return _.map(n.getActions(e,(e=>!(t&&!t(e))&&(!e.completed&&(!e.rejected||e.controlReject())))),(e=>r?e:e.get()))},n.getTempUserInfo=function(){var e=n.getTempActions("userInfo",null,!0);return e.length?e[0]:null},n.triggerGlobal=function(){t.emit("change",{account:n}),_.each(n.actions.value,(e=>{f(e)}))};var f=function(e){var r=e.rejected?"rejected":e.completed?"completed":e.transaction?"sent":"relay",o="relay"==r||"sent"==r?"relayorsent":r;if(r&&e.id&&!s[o][e.id])return t.emit("actionFiltered",{action:e,address:n.address,status:r}),s[o][e.id]=!0,!0};n.save=function(){t.save()},n.trigger=function(e){t.emit("change",{action:e,account:n}),e&&(t.emit("action",{action:e,address:n.address}),f(e)),t.save()},n.getStatus=function(){if(n.status.value)return"registered";var e=n.getActions("userInfo"),t=_.filter(e,(e=>e.completed)),r=_.filter(e,(e=>!e.completed&&!e.rejected));return t.length?"undefined_status":r.length?r[0].transaction?"in_progress_transaction":n.unspents.value.length?"in_progress_hasUnspents":n.unspents.willChange?"in_progress_wait_unspents":"not_in_progress":"not_in_progress_no_processing"};var m=function(e){return _.reduce(e,((e,t)=>t.amount+e),0)};return n.allAddresses=function(){return(t.app.platform.sdk.addresses.storage.addresses||[]).concat(n.address)},n.actualBalance=function(e){e||(e=[n.address]);var t={total:0,actual:0,tempbalance:0};if(!n.unspents.value.length)return t;var r=_.reduce(n.actions.value,((t,n)=>{if(n.completed||n.rejected)return t;var r=_.reduce(n.outputs,((t,n)=>_.find(e,(e=>e==n.address))?t+n.amount:t),0);return t+r}),0),o=n.getActualUnspents(null,e),s=n.getActualUnspents("withUnconfirmed",e);return t.total=Number((m(o)+r).toFixed(8)),t.actual=Number((m(s)+r).toFixed(8)),t.tempbalance=Number((r+m(_.filter(s,(e=>!u(e))))).toFixed(8)),t},n.parent=t,n.getActionById=l,n},Actions=function(e,t,n=localStorage){var r=this,o="actions_v0",s={},i={},a={},c={feerate:0},d=!1,u=null;return r.clbk=function(e,t,n){a[e]||(a[e]={}),n?a[e][t]=n:a[e][t]&&delete a[e][t]},r.on=function(e,t){i[e]||(i[e]=[]),i[e].push(t)},r.off=function(e,t){i[e]||(i[e]=[]),i[e]=_.filter(i[e],(function(e){return e!=t}))},r.estimateFee=function(){return c.feerate?Promise.resolve(c.feerate):(c.feerate=1e-5,t.rpc("estimateSmartFee",[1]).catch((e=>Promise.resolve({}))).then((e=>(c.feerate=Math.max(e.feerate||1e-5,1e-5),Promise.resolve(c.feerate)))))},r.ws={transaction:function(e){_.each(s,(t=>{t.ws.transaction(e)}))},block:function(e){_.each(s,(t=>{t.ws.block(e)}))}},r.processing=function(){_.each(s,(e=>{console.log(e,"|||aa||"),e.processing()}))},r.addAction=function(e,t,n,o={}){if(!e)return Promise.reject("address");if(!t)return Promise.reject("object");var s=r.addAccount(e).addAction(t,n,o);return r.save(),s},r.addActionAndSendIfCan=function(t,n,o,i={}){if(o||(o=e.user.address.value),!o)return Promise.reject("actions_address");var a=r.addAction(o,t,n,i);return s[o].checkAccountReadySend()?a.processingWithIteractions(!0).then((()=>Promise.resolve(a))).catch((e=>i.rejectIfError?(a.rejected="cantsendnow",Promise.reject(e)):a.rejected?Promise.reject(e):Promise.resolve(a))):Promise.resolve(a)},r.cancelAction=function(e,t){return e?t?s[e]?s[e].cancelAction(t):Promise.reject("actions_noAccount"):Promise.reject("actions_actionId"):Promise.reject("actions_noAddress")},r.addAccount=function(e){return s[e]||(s[e]=new Account(e,r)),s[e]},r.getCurrentAccount=function(){if(e.user&&e.user.address&&e.user.address.value)return s[e.user.address.value]||void 0},r.save=function(){try{n[o]=JSON.stringify((e={},_.each(s,((t,n)=>{e[n]=t.export()})),e))}catch(e){}var e},r.load=function(){try{e=JSON.parse(n[o]||"{}"),s={},_.each(e,((e,t)=>{s[t]=new Account(t,r),s[t].import(e)}))}catch(e){throw console.error(e),e}var e},r.getActionById=function(e){var t=null;return _.find(s,(n=>{var r=n.getActionById(e);if(r)return t=r,!0})),t},r.getActionsByApp=function(e){var t=[],n=r.getCurrentAccount();return n?(_.each(n.actions.value,(n=>{n.settings.application==e&&t.push(e)})),t):t},r.init=function(){if(!d){d=!0,r.load(),e.platform.sdk.syncStorage.on("change",o,(function(e){var t;if(e.newValue!=e.oldValue)try{t=JSON.parse(e.newValue||"{}"),_.each(t,((e,t)=>{s[t]||(s[t]=new Account(t,r)),s[t].import(e,"withcompleted"),s[t].triggerGlobal()}))}catch(e){console.error(e)}})),r.processing();u&&clearInterval(u),u=setInterval((()=>{r.processing()}),3e3),window.addEventListener("beforeunload",(()=>{_.each(s,(e=>{e.clearThisWaitUserAction()}))}))}},r.prepare=function(e){r.init(),e&&e()},r.destroy=function(){i={},s={},u&&clearInterval(u),u=null,d=!1},r.getAccounts=function(){return s},r.api=t,r.app=e,r.emit=function(e,t){_.each(i[e]||[],(function(e){e(t)})),_.each(a[e]||{},(function(e){e(t)}))},r};"undefined"!=typeof module?module.exports={Actions:Actions,Account:Account,Action:Action}:(window.Actions=Actions,window.Account=Account,window.Action=Action);