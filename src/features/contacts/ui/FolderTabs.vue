<script setup lang="ts">
import { ref, computed, watch, onMounted, nextTick } from "vue";
import { useChatStore } from "@/entities/chat";

type FilterValue = "all" | "personal" | "groups" | "invites";

interface Props {
  modelValue: FilterValue;
}

const props = defineProps<Props>();
const emit = defineEmits<{ "update:modelValue": [value: FilterValue] }>();
const chatStore = useChatStore();
const { t } = useI18n();

const tabs = computed(() => [
  { value: "all" as const, label: t("tabs.all") },
  { value: "personal" as const, label: t("tabs.personal") },
  { value: "groups" as const, label: t("tabs.groups") },
  { value: "invites" as const, label: t("tabs.invites") },
]);

const visibleTabs = computed(() =>
  tabs.value.filter(t => t.value !== "invites" || chatStore.inviteCount > 0)
);

const tabRefs = ref<HTMLElement[]>([]);
const indicatorStyle = ref<{ left: string; width: string }>({ left: "0px", width: "0px" });

const updateIndicator = () => {
  const idx = visibleTabs.value.findIndex(t => t.value === props.modelValue);
  const el = tabRefs.value[idx];
  if (el) {
    indicatorStyle.value = {
      left: `${el.offsetLeft + el.offsetWidth * 0.25}px`,
      width: `${el.offsetWidth * 0.5}px`,
    };
  }
};

watch(() => props.modelValue, () => nextTick(updateIndicator));
watch(visibleTabs, () => nextTick(updateIndicator));
onMounted(() => nextTick(updateIndicator));
</script>

<template>
  <div class="relative flex border-b border-neutral-grad-0">
    <button
      v-for="(tab, i) in visibleTabs"
      :key="tab.value"
      :ref="(el) => { if (el) tabRefs[i] = el as HTMLElement }"
      class="relative flex-1 py-2.5 text-center text-sm font-medium transition-colors"
      :class="props.modelValue === tab.value ? 'text-color-bg-ac' : 'text-text-on-main-bg-color hover:text-text-color'"
      @click="emit('update:modelValue', tab.value)"
    >
      {{ tab.label }}
      <span
        v-if="tab.value === 'invites' && chatStore.inviteCount > 0"
        class="ml-1 inline-flex h-4 min-w-4 items-center justify-center rounded-full bg-color-bg-ac px-1 text-[10px] font-medium text-white"
      >
        {{ chatStore.inviteCount }}
      </span>
    </button>
    <!-- Sliding indicator -->
    <div
      class="absolute bottom-0 h-0.5 rounded-full bg-color-bg-ac transition-all duration-200 ease-out"
      :style="indicatorStyle"
    />
  </div>
</template>
